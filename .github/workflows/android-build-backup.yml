name: Build APK Backup (Alternative Method)

on:
  workflow_run:
    workflows: ["Build Claude Code Router APK (No Cache - Reliable)"]
    types: [failed]

jobs:
  build-apk-backup:
    runs-on: ubuntu-latest
    env:
      BUILD_TYPE: release

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---- Setup Environment ----
      - name: Setup Environment
        run: |
          echo "ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙƒØ§Ø´..."
          export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.caching=false"
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools

      # ---- Install Java and Gradle ----
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk gradle

      # ---- Setup Android SDK ----
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ---- Nuclear Cache Clear ----
      - name: Nuclear Cache Clear
        run: |
          echo "â˜¢ï¸ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒØ§Ø´..."
          sudo rm -rf /root/.gradle
          sudo rm -rf /home/runner/.gradle
          sudo rm -rf ~/.gradle
          sudo rm -rf ~/.android
          sudo rm -rf .gradle
          sudo rm -rf build
          sudo rm -rf app/build
          sudo rm -rf /tmp/gradle*
          echo "âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø´ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹"

      # ---- Create Minimal gradle.properties ----
      - name: Create Minimal Config
        run: |
          cat > gradle.properties << EOF
          org.gradle.daemon=false
          org.gradle.caching=false
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

      # ---- Install SDK Components ----
      - name: Install SDK Components
        run: |
          yes | sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      # ---- Build with Minimal Commands ----
      - name: Build APK Minimal
        run: |
          echo "ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø©..."
          gradle clean
          gradle assembleRelease --no-daemon --no-build-cache --no-configuration-cache --stacktrace

      # ---- Find APK ----
      - name: Find APK
        id: apk
        run: |
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† APK..."
          find . -name "*.apk" -type f | head -1 > apk_path.txt
          if [ -s apk_path.txt ]; then
            APK_PATH=$(cat apk_path.txt)
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ APK: $APK_PATH"
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ APK"
            find . -name "*.apk" -type f
            exit 1
          fi

      # ---- Upload Artifact ----
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-code-router-backup-release.apk
          path: ${{ steps.apk.outputs.apk_path }}