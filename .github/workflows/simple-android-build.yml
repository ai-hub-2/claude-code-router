name: Simple Android APK Build

on:
  push:
    branches: [ main, master ]
    paths:
      - 'android_app/**'
      - '.github/workflows/simple-android-build.yml'
  workflow_dispatch:
    inputs:
      build-type:
        description: "Build Type"
        required: true
        default: "debug"
        type: choice
        options: [debug, release]

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      BUILD_TYPE: ${{ inputs.build-type || 'debug' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Show Environment Info
        run: |
          echo "ðŸ” Environment Information:"
          echo "Java version:"
          java -version
          echo ""
          echo "Android SDK: $ANDROID_SDK_ROOT"
          echo "Build type: ${{ env.BUILD_TYPE }}"
          echo "Working directory: $(pwd)"

      - name: Check Android Project
        run: |
          echo "ðŸ“ Checking Android project..."
          if [ ! -d "android_app" ]; then
            echo "âŒ Android project not found!"
            exit 1
          fi
          echo "âœ… Android project found"
          echo "Project structure:"
          ls -la android_app/
          echo ""
          echo "Gradle files:"
          find android_app -name "*.gradle" -type f

      - name: Install Gradle
        run: |
          echo "ðŸ“¦ Installing Gradle..."
          sudo apt-get update
          sudo apt-get install -y gradle
          echo "âœ… Gradle installed"
          gradle --version

      - name: Build APK with Gradle
        run: |
          echo "ðŸ—ï¸ Building Android APK..."
          cd android_app
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          echo ""
          echo "Building ${{ env.BUILD_TYPE }} APK..."
          gradle assemble${{ env.BUILD_TYPE }} --stacktrace --info
          echo "âœ… Build completed"

      - name: Find and Upload APK
        run: |
          echo "ðŸ” Searching for APK files..."
          cd android_app
          
          # Search for APK files
          APK_FILES=$(find . -name "*.apk" -type f)
          
          if [ -z "$APK_FILES" ]; then
            echo "âŒ No APK files found!"
            echo "Build output directory:"
            find . -name "build" -type d
            echo "Contents of build directories:"
            find . -name "build" -type d -exec ls -la {} \;
            exit 1
          fi
          
          echo "âœ… Found APK files:"
          echo "$APK_FILES"
          
          # Get the first APK file
          APK_PATH=$(echo "$APK_FILES" | head -n 1)
          echo "Selected APK: $APK_PATH"
          
          # Get file size
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "APK Size: $APK_SIZE"
          
          # Upload as artifact
          echo "ðŸ“¤ Uploading APK as artifact..."
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Claude-Code-Router-Android-${{ env.BUILD_TYPE }}.apk
          path: android_app/${{ steps.find-and-upload-apk.outputs.apk_path }}
          retention-days: 30

      - name: Success Summary
        run: |
          echo "ðŸŽ‰ Android APK build completed successfully!"
          echo "Build Type: ${{ env.BUILD_TYPE }}"
          echo "APK Path: ${{ steps.find-and-upload-apk.outputs.apk_path }}"
          echo "âœ… APK is ready for download!"